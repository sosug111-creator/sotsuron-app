<!DOCTYPE html>
<html lang="ja">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9RG9T3E5N9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-9RG9T3E5N9');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anke Share - アンケート相互回答プラットフォーム</title>

    <meta property="og:title" content="Anke Share - アンケート相互回答プラットフォーム">
    <meta property="og:description" content="大学生のためのアンケート交換サイト。ポイントを貯めて自分のアンケートを掲載しよう！">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ankeshare-app.vercel.app/"> 
    <meta property="og:image" content="https://ankeshare-app.vercel.app/ogp.png"> 
    <meta name="twitter:card" content="summary_large_image">

    <link rel="icon" type="image/png" href="favicon.svg">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* プロフェッショナルデザインCSS */
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #64748b;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: "Noto Sans JP", sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0; padding: 0; padding-top: 70px;
            -webkit-font-smoothing: antialiased;
            line-height: 1.5;
        }

        /* ヘッダー */
        header {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            height: 60px;
            padding: 0 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            position: fixed; top: 0; left: 0; width: 100%; box-sizing: border-box; z-index: 1000;
        }
        .logo {
            font-weight: 800; font-size: 1.25rem; color: var(--primary);
            letter-spacing: -0.02em; display: flex; align-items: center; gap: 8px;
        }
        .status-bar { font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 15px; color: var(--text-sub); }
        .status-item { display: flex; align-items: center; gap: 6px; }
        .status-item i { color: var(--primary); }
        .point-highlight { color: var(--text-main); font-weight: bold; }

        /* レイアウト */
        .container { max-width: 640px; margin: 0 auto; padding: 1.5rem; }

        /* ステータスカード */
        .my-post-area {
            background: white; border-radius: 12px; padding: 1.5rem;
            text-align: center; margin-bottom: 2rem;
            box-shadow: var(--shadow-sm); border: 1px solid var(--border);
        }
        .my-post-area h2 { margin: 0 0 1rem 0; font-size: 1.1rem; color: var(--text-main); display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        /* プログレスバー */
        .progress-container {
            background: #f1f5f9; border-radius: 6px; height: 8px; width: 100%; margin: 1rem 0; overflow: hidden;
        }
        #progressBar {
            background: var(--primary); width: 0%; height: 100%; border-radius: 6px; transition: width 0.4s ease;
        }

        /* アクションボタン */
        .action-btn {
            background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem;
            border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.95rem;
            width: 100%; max-width: 300px; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.2s;
        }
        .action-btn:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-1px); }
        .action-btn:disabled { background: #cbd5e1; cursor: not-allowed; color: #64748b; }

        /* リスト */
        .section-title {
            text-align: center; margin-bottom: 1.5rem; color: var(--text-sub); font-size: 0.9rem; font-weight: 500;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .section-title::before, .section-title::after {
            content: ""; display: block; height: 1px; width: 30px; background: var(--border);
        }

        .survey-list { display: flex; flex-direction: column; gap: 1rem; }
        
        .card {
            background: white; padding: 1.25rem; border-radius: 12px;
            box-shadow: var(--shadow-sm); border: 1px solid var(--border);
            transition: all 0.2s ease; display: flex; justify-content: space-between; align-items: center; gap: 1rem;
        }
        .card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: #cbd5e1; }
        
        .card-info { flex: 1; min-width: 0; }
        .card-info h3 { margin: 0 0 0.5rem 0; font-size: 1rem; line-height: 1.4; color: var(--text-main); }
        
        .meta-row { display: flex; flex-wrap: wrap; gap: 10px; font-size: 0.75rem; color: var(--text-sub); align-items: center; }
        .meta-item { display: flex; align-items: center; gap: 4px; background: #f8fafc; padding: 2px 8px; border-radius: 4px; border: 1px solid var(--border); }
        .meta-item i { font-size: 0.7rem; color: #94a3b8; }

        .report-link { font-size: 0.75rem; color: #94a3b8; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; margin-top: 8px; transition: color 0.2s; }
        .report-link:hover { color: #ef4444; }

        /* 回答ボタン（カード内） */
        .card-btn {
            background: white; color: var(--primary); border: 1px solid var(--primary);
            padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.85rem;
            white-space: nowrap; transition: all 0.2s; min-width: 80px; text-align: center;
        }
        .card-btn:hover { background: #eff6ff; }
        .card-btn:disabled { background: #f1f5f9; color: #94a3b8; border-color: #e2e8f0; cursor: default; }

        /* シェアエリア */
        .share-area { margin-top: 3rem; text-align: center; padding-top: 2rem; border-top: 1px solid var(--border); }
        .share-btns { display: flex; justify-content: center; gap: 10px; margin-top: 1rem; }
        .share-btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
            padding: 8px 16px; border-radius: 99px; color: white; text-decoration: none;
            font-weight: bold; font-size: 0.85rem; cursor: pointer; border: none; transition: opacity 0.2s;
        }
        .share-btn:hover { opacity: 0.9; }
        .btn-x { background: #000; }
        .btn-line { background: #06c755; }

        /* スマホ対応 */
        @media (max-width: 600px) {
            header { padding: 0 1rem; height: auto; py: 0.8rem; flex-direction: column; gap: 5px; padding-top:10px; padding-bottom:10px;}
            body { padding-top: 90px; }
            .card { flex-direction: column; align-items: stretch; gap: 1rem; }
            .card-btn { width: 100%; padding: 0.8rem; }
        }

        /* モーダル */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 12px;
            max-width: 480px; width: 90%; box-shadow: var(--shadow-md);
        }
        .modal-title { font-size: 1.1rem; font-weight: bold; text-align: center; margin-bottom: 1rem; color: var(--text-main); }
        .modal-list { font-size: 0.9rem; color: var(--text-sub); padding-left: 1.2rem; margin-bottom: 1.5rem; }
        .modal-list li { margin-bottom: 0.5rem; }
        .agree-area { text-align: center; margin-top: 1.5rem; }
        .agree-label { display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 500; font-size: 0.9rem; cursor: pointer; }
    </style>
</head>
<body>
    <div id="welcomeModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title"><i class="fa-solid fa-circle-info" style="color:var(--primary);"></i> 利用上の注意</div>
            <ul class="modal-list">
                <li>不適切な投稿は即時削除・通報されます。</li>
                <li>掲載期間は登録日から<strong>2週間</strong>です。</li>
                <li>ポイントはブラウザ（端末）に保存されます。</li>
                <li>トラブルに関して管理人は責任を負いません。</li>
            </ul>
            <div style="font-size:0.8rem; text-align:center; background:#f8fafc; padding:10px; border-radius:6px; color:var(--text-sub);">
                削除依頼・お問い合わせ<br>
                <a href="mailto:sosug1411@gmail.com" style="color:var(--primary);">sosug1411@gmail.com</a>
            </div>
            <div class="agree-area">
                <label class="agree-label"><input type="checkbox" id="agreeCheck"> 上記の内容に同意します</label>
                <button id="closeModalBtn" class="action-btn" style="width:100%; margin-top:1rem;" disabled>利用を開始する</button>
            </div>
        </div>
    </div>

    <header>
        <div class="logo"><i class="fa-solid fa-layer-group"></i> Anke Share</div>
        <div class="status-bar">
            <div class="status-item"><i class="fa-solid fa-list"></i> <span id="surveyCountDisplay" class="point-highlight">0件</span></div>
            <div class="status-item"><i class="fa-solid fa-coins"></i> <span id="pointDisplay" class="point-highlight">0 pt</span></div>
        </div>
    </header>

    <div class="container">
        <div class="my-post-area">
            <h2><i class="fa-regular fa-paper-plane"></i> あなたのアンケート掲載</h2>
            
            <div id="status-incomplete">
                <p style="color:var(--text-sub); font-size:0.9rem; margin-bottom:0.5rem;">
                    あと <strong id="pointsNeeded" style="color:var(--primary); font-size:1.2rem;">3</strong> 回答で掲載可能です
                </p>
                
                <div class="progress-container">
                    <div id="progressBar"></div>
                </div>
                
                <button class="action-btn" disabled><i class="fa-solid fa-lock"></i> 条件未達成</button>
            </div>

            <div id="status-complete" style="display: none;">
                <p style="color:#059669; font-weight:bold; margin-bottom:1rem;"><i class="fa-solid fa-check-circle"></i> 条件を達成しました</p>
                <button id="activePostBtn" class="action-btn" style="background:#059669;"><i class="fa-solid fa-pen"></i> アンケートを登録する</button>
            </div>
        </div>

        <div class="section-title">新着アンケート</div>

        <div class="survey-list" id="survey-list">
            </div>

        <div class="share-area">
            <p style="font-size:0.85rem; color:var(--text-sub);">このツールをシェアして回答を集めよう</p>
            <div class="share-btns">
                <button class="share-btn btn-x" onclick="window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent('大学生のためのアンケート回答プラットフォーム「Anke Share」\nポイントを貯めて自分のアンケートを掲載しよう！')+'&url='+encodeURIComponent(location.href), '_blank')">
                    <i class="fa-brands fa-x-twitter"></i> シェア
                </button>
                <button class="share-btn btn-line" onclick="window.open('https://social-plugins.line.me/lineit/share?url='+encodeURIComponent(location.href), '_blank')">
                    <i class="fa-brands fa-line"></i> 送る
                </button>
            </div>
        </div>
    </div>

    <script>
        // ▼▼▼ 設定エリア (変更不要) ▼▼▼
        const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4Qjh20XKMyAtIWUQpOlaqKfEa0mGuzdMC7q1rihKbRuDMczRJTL6wR0oY3ouipDK8uFhuVhzYwMh9/pub?output=csv";
        const validPeriodDays = 14;
        const postFormUrl = "post.html";
        const requiredPoints = 3;
        const reportFormUrl = "https://docs.google.com/forms/d/e/1FAIpQLSdSezMq8XimmjdBuHSrCDuJin-U_KSeIEpBM0jjWEU51X2FUg/viewform?usp=dialog"; 
        // ▲▲▲ 設定ここまで ▲▲▲

        let savedPoints = localStorage.getItem('sotsuron_points');
        let points = savedPoints ? parseInt(savedPoints) : 0;
        let answeredSurveys = JSON.parse(localStorage.getItem('anke_share_answered_list')) || [];

        updateDisplay();

        window.onload = function() {
            if(savedPoints) points = parseInt(savedPoints);
            updateDisplay();

            const listElement = document.getElementById('survey-list');
            listElement.innerHTML = '<p style="text-align:center; padding:2rem; color:#64748b; font-size:0.9rem;"><i class="fa-solid fa-spinner fa-spin"></i> データを読み込んでいます...</p>';

            fetch(sheetUrl + "&t=" + new Date().getTime())
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.text();
                })
                .then(text => {
                    let rows = parseCSV(text);
                    const header = rows[0];
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    const dataRows = rows.slice(1).filter(row => {
                        if (row.length < 5) return false; 
                        const registeredDateStr = row[4];
                        const registeredDate = new Date(registeredDateStr);
                        if (isNaN(registeredDate.getTime())) return false;
                        const deadline = new Date(registeredDate);
                        deadline.setDate(deadline.getDate() + validPeriodDays);
                        return today <= deadline;
                    });
                    
                    document.getElementById('surveyCountDisplay').innerText = dataRows.length + " 件";
                    listElement.innerHTML = ""; 

                    if (dataRows.length === 0) {
                        listElement.innerHTML = `
                            <div style="text-align:center; padding:3rem; color:#64748b;">
                                <i class="fa-regular fa-folder-open" style="font-size:2rem; margin-bottom:1rem; opacity:0.5;"></i>
                                <p>現在募集中のアンケートはありません</p>
                            </div>
                        `;
                        return;
                    }

                    dataRows.sort(() => Math.random() - 0.5);
                    rows = [header, ...dataRows];

                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        const title = row[0];
                        const tag = row[1];
                        const time = row[2];
                        const url = (row[3] || "").trim();
                        const registeredDateStr = row[4];

                        const uniqueId = url + "_" + registeredDateStr;
                        const registeredDate = new Date(registeredDateStr);
                        const deadline = new Date(registeredDate);
                        deadline.setDate(deadline.getDate() + validPeriodDays);
                        
                        const diffTime = deadline - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        // 絵文字を使わず、色とアイコンで表現
                        let deadlineHTML = "";
                        if (diffDays <= 3) {
                            deadlineHTML = `<span class="meta-item" style="color:#ef4444; border-color:#fecaca; background:#fef2f2;"><i class="fa-regular fa-clock" style="color:#ef4444;"></i> 残り${diffDays}日</span>`;
                        } else {
                            deadlineHTML = `<span class="meta-item"><i class="fa-regular fa-calendar"></i> 残り${diffDays}日</span>`;
                        }

                        const isAnswered = answeredSurveys.includes(uniqueId);
                        
                        let buttonHTML = isAnswered 
                            ? `<button class="card-btn" disabled><i class="fa-solid fa-check"></i> 済</button>`
                            : `<button class="card-btn" onclick="clickSurvey('${uniqueId}', '${url}', this)">回答</button>`;

                        const reportLinkHTML = `<a href="${reportFormUrl}" target="_blank" rel="noopener noreferrer" class="report-link"><i class="fa-solid fa-circle-exclamation"></i> 報告</a>`;

                        const cardHTML = `
                            <div class="card">
                                <div class="card-info">
                                    <h3>${title}</h3>
                                    <div class="meta-row">
                                        <span class="meta-item"><i class="fa-solid fa-tag"></i> ${tag}</span>
                                        <span class="meta-item"><i class="fa-regular fa-hourglass"></i> ${time}</span>
                                        ${deadlineHTML}
                                    </div>
                                    ${reportLinkHTML}
                                </div>
                                ${buttonHTML}
                            </div>
                        `;
                        listElement.insertAdjacentHTML('beforeend', cardHTML);
                    }
                })
                .catch(err => {
                    console.error(err);
                    listElement.innerHTML = '<p style="text-align:center; color:#ef4444;"><i class="fa-solid fa-triangle-exclamation"></i> 読み込みエラー</p>';
                });
        };

        function updateDisplay() {
            document.getElementById('pointDisplay').innerText = points + " pt";
            let remaining = requiredPoints - points;
            let progressPercent = Math.min(100, (points / requiredPoints) * 100);
            
            const bar = document.getElementById('progressBar');
            if(bar) bar.style.width = progressPercent + "%";

            const incompleteArea = document.getElementById('status-incomplete');
            const completeArea = document.getElementById('status-complete');
            
            if(incompleteArea && completeArea) {
                if (remaining <= 0) {
                    incompleteArea.style.display = 'none';
                    completeArea.style.display = 'block';
                    const activeBtn = document.getElementById('activePostBtn');
                    if(activeBtn) activeBtn.onclick = function() { window.open(postFormUrl, '_blank'); };
                } else {
                    incompleteArea.style.display = 'block';
                    completeArea.style.display = 'none';
                    document.getElementById('pointsNeeded').innerText = remaining;
                }
            }
        }

        function clickSurvey(uniqueId, url, btnElement) {
            if(!confirm("アンケートページへ移動しますか？")) return;
            points++;
            localStorage.setItem('sotsuron_points', points);
            answeredSurveys.push(uniqueId);
            localStorage.setItem('anke_share_answered_list', JSON.stringify(answeredSurveys));

            btnElement.innerHTML = '<i class="fa-solid fa-check"></i> 済';
            btnElement.disabled = true;

            updateDisplay();
            window.open(url, '_blank');
        }

        function parseCSV(text) {
            const rows = []; let row = []; let inQuote = false; let currentCell = "";
            for (let i = 0; i < text.length; i++) {
                const char = text[i]; const nextChar = text[i+1];
                if (char === '"') {
                    if (inQuote && nextChar === '"') { i++; currentCell += '"'; } else { inQuote = !inQuote; }
                } else if (char === ',' && !inQuote) {
                    row.push(currentCell); currentCell = "";
                } else if ((char === '\r' || char === '\n') && !inQuote) {
                    if (currentCell || row.length > 0) row.push(currentCell);
                    if (row.length > 0) rows.push(row);
                    row = []; currentCell = "";
                    if (char === '\r' && nextChar === '\n') i++;
                } else { currentCell += char; }
            }
            if (currentCell || row.length > 0) { row.push(currentCell); rows.push(row); }
            return rows;
        }

        const modal = document.getElementById('welcomeModal');
        const checkbox = document.getElementById('agreeCheck');
        const closeBtn = document.getElementById('closeModalBtn');
        if (localStorage.getItem('anke_share_agreed') === 'true') { if(modal) modal.style.display = 'none'; }
        if(checkbox && closeBtn) {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    closeBtn.disabled = false; closeBtn.style.opacity = "1";
                } else {
                    closeBtn.disabled = true; closeBtn.style.opacity = "0.5";
                }
            });
            closeBtn.addEventListener('click', function() {
                modal.style.display = 'none'; localStorage.setItem('anke_share_agreed', 'true');
            });
        }
  </script>
    <footer style="text-align:center; padding:2rem; margin-top:3rem; font-size:0.75rem; color:#94a3b8; border-top:1px solid #e2e8f0;">
        <p>Anke Share - 学生のためのアンケートプラットフォーム</p>
        <p>お問い合わせ: <a href="mailto:sosug1411@gmail.com" style="color:inherit;">sosug1411@gmail.com</a></p>
    </footer>
</body>
</html>